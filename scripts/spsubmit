#!/usr/bin/env python

from subprocess import call
from importlib.machinery import SourceFileLoader
import os, sys

if __name__ == '__main__':
	cwd = os.path.dirname(os.path.realpath(__file__))
	sprun = SourceFileLoader('get_config', cwd + '/sprun').load_module()
	get_config = getattr(sprun, 'get_config')

	config = get_config()
	system = config['system']
	path = config['directory']

	workdir = path['workdir']
	outdir = workdir + '/' + path['output']

	cmd = '#!/bin/bash\n'
	cmd += '#SBATCH --job-name=%s\n' % system['name']
	cmd += '#SBATCH --output=%s\n' % (outdir+'/'+'output.log')
	cmd += '#SBATCH --ntasks-per-node=%s\n' % system['tasks_per_node']
	cmd += '#SBATCH --nodes=%s\n' % system['nodes']
	cmd += '#SBATCH --time=%s\n' % system['time']

	cmd += 'module load %s \n' % system['modules']
	cmd += 'srun python ' + cwd + '/sprun'

	for i in range(1, len(sys.argv)):
		cmd += ' ' + sys.argv[i]

	slurm_file = outdir + '/job.bash'
	with open(slurm_file, 'w') as f:
		f.write(cmd)

	call('sbatch ' + slurm_file, shell=True)
