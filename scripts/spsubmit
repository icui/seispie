#!/usr/bin/env python

from seispie.tools.config import get_config
from subprocess import call
import os, sys

if __name__ == '__main__':
	config = get_config()
	slurm = config['slurm']
	path = config['directory']

	workdir = path['workdir']
	outdir = workdir + '/' + path['output']

	cmd = '#!/bin/bash\n'
	cmd += '#SBATCH --job-name=%s\n' % slurm['name']
	cmd += '#SBATCH --output=%s\n' % (outdir+'/'+'output.log')
	cmd += '#SBATCH --ntasks-per-node=%s\n' % slurm['tasks_per_node']
	cmd += '#SBATCH --nodes=%s\n' % slurm['nodes']
	cmd += '#SBATCH --time=%s\n' % slurm['time']
	cmd += 'srun ' + os.path.dirname(os.path.realpath(__file__)) + '/sprun'

	for i in range(1, len(sys.argv)):
		cmd += ' ' + sys.argv[i]

	slurm_file = outdir + '/job.bash'
	with open(slurm_file, 'w') as f:
		f.write(cmd)

	call('sbatch ' + slurm_file, shell=True)
