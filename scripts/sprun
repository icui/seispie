#!/usr/bin/env python

from sys import modules
from importlib import import_module
from os import path, getcwd, makedirs
from argparse import ArgumentParser
from configparser import ConfigParser


def get_config():
	# parse arguments
	parser = ArgumentParser()
	parser.add_argument('--workdir', nargs='?', default=getcwd())
	parser.add_argument('--config_file', nargs='?', default='config.ini')
	args = parser.parse_args()

	# assertions
	workdir = args.workdir
	config_file = path.join(workdir, args.config_file)
	assert path.exists(workdir)
	assert path.exists(config_file)

	# parse config.ini
	config = ConfigParser()
	config.read(config_file)
	config['directory']['workdir'] = workdir

	# ensure output directory exists
	outdir = path.join(workdir, config['directory']['output'])
	if not path.exists(outdir):
		makedirs(outdir)

	return config


def import_object(section, name):
	module = import_module('seispie.' + section + '.' + name);
	return getattr(module, name)()

		
def setup(config):
	# create workflow
	workflow = import_object('workflow', config['workflow']['mode'])
	workflow.setup(config['workflow'])
	
	# system
	system = import_module('seispie.workflow.system.' + config['workflow']['system'])
	for method in ['call']:
		setattr(workflow, method, getattr(system, method))

	# load components
	for section in workflow.modules:
		module = import_object(section, config[section]['method'])
		module.setup(config[section])
		setattr(workflow, section, module)

	# start workflow
	workflow.run()


if __name__ == '__main__':
	setup(get_config())
